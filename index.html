
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>Adam_D'H7 — PDF Viewer</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.115/pdf.min.js"></script>

  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --gap: 18px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header (kept minimal) */
    .header {
      position: sticky;
      top: 0;
      z-index: 60;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logo { font-weight:700; font-size:18px; color:var(--fg); }

    /* Explorer area */
    #explorerView { padding: 14px; min-height: calc(100vh - 60px); background: var(--bg); }

    .post-card { background:#0f0f10; border-radius:12px; padding:12px; margin-bottom:14px; box-shadow: 0 4px 18px rgba(0,0,0,0.6); }
    .post-name { font-weight:700; margin-bottom:8px; color:var(--fg); }
    .post-desc, .post-text { color:#dcdcdc; font-size:14px; margin-bottom:8px; }

    .post-thumb-container { display:block; width:100%; background:#000; border-radius:8px; overflow:hidden; cursor:pointer; text-align:center; padding:8px; }
    .post-thumb { max-width:100%; height:auto; display:inline-block; object-fit:contain; }

    /* Ad overlay left intact */
    .ad-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; z-index:10000; align-items:center; justify-content:center; }
    .ad-container { width:100%; max-width:1200px; height:80%; background:#000; border-radius:12px; overflow:hidden; }

    /* === PDF overlay: FULLSCREEN === */
    .pdf-overlay {
      position: fixed;
      inset: 0; /* full screen */
      display: none; /* shown by JS */
      z-index: 12000;
      background: var(--bg);
      align-items: stretch;
      justify-content: stretch;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Container fills everything */
    .pdf-container {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      overflow: hidden;
      position: relative;
      background: var(--bg);
    }

    /* Only a single close button in the corner */
    .pdf-close {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 13000;
      background: rgba(0,0,0,0.5);
      color: var(--fg);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight:600;
      backdrop-filter: blur(6px);
    }

    /* Canvas wrapper scrolls and centers pages */
    .pdf-canvas-wrap {
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      padding: 20px;
      justify-content: flex-start;
    }

    canvas.pdf-page {
      max-width: calc(100% - 20px);
      width: auto;
      height: auto;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      background: #000;
      border-radius: 4px;
      display: block;
    }

    /* Fallback iframe (if pdf.js not available) */
    .pdf-fallback-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
    }

    /* small screens tweaks */
    @media (max-width: 600px) {
      .pdf-close { top: 8px; right: 8px; padding: 8px; font-size:14px; }
      .pdf-canvas-wrap { padding: 12px; gap: 14px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">Adam_D'H7</div>
  </div>

  <div id="explorerView" role="main" aria-live="polite"></div>

  <!-- Ad overlay (kept) -->
  <div id="adOverlay" class="ad-overlay" aria-hidden="true" role="dialog">
    <div class="ad-container">
      <iframe id="prerollFrame" src="about:blank" allow="autoplay; fullscreen" title="Pré-roll Ad" style="width:100%;height:100%;border:0;background:#000;"></iframe>
    </div>
  </div>

  <!-- PDF overlay (FULLSCREEN) -->
  <div id="pdfOverlay" class="pdf-overlay" role="dialog" aria-hidden="true" aria-label="Lecteur PDF">
    <div class="pdf-container" role="document">
      <button id="pdfClose" class="pdf-close" aria-label="Fermer la lecture">Fermer</button>
      <div id="pdfCanvasWrap" class="pdf-canvas-wrap" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /***** PDF.js setup *****/
    const pdfjsLib = window['pdfjsLib'] || window['pdfjs-dist/build/pdf'];
    if (pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.115/pdf.worker.min.js';
    }

    const explorer = document.getElementById('explorerView');
    const pdfOverlay = document.getElementById('pdfOverlay');
    const pdfCanvasWrap = document.getElementById('pdfCanvasWrap');
    const pdfCloseBtn = document.getElementById('pdfClose');
    const adOverlay = document.getElementById('adOverlay');
    const prerollFrame = document.getElementById('prerollFrame');

    let allData = [];

    /* load index.json -> files listed inside should be JSON with posts */
    fetch('index.json')
      .then(r => {
        if (!r.ok) throw new Error('index.json not found');
        return r.json();
      })
      .then(files => Promise.all(files.map(f => fetch(f).then(r => r.ok ? r.json() : null).catch(()=>null))))
      .then(jsons => {
        jsons.forEach(j => { if (!j) return; if (Array.isArray(j)) allData.push(...j); else allData.push(j); });
        shuffle(allData);
        displayExplorer(allData);
      })
      .catch(err => {
        explorer.innerHTML = '<div style="color:#999;padding:20px;text-align:center">Pa kapab chaje kontni (index.json)</div>';
        console.error(err);
      });

    function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

    function displayExplorer(list){
      explorer.innerHTML = '';
      list.forEach(post => {
        const cat = (post.Catégorie||post.Categorie||post.category||'').toString().toLowerCase();
        if (cat !== 'poste') return;

        const card = document.createElement('div');
        card.className = 'post-card';

        const title = document.createElement('div'); title.className = 'post-name'; title.textContent = post.Name || '';
        const desc = document.createElement('div'); desc.className = 'post-desc'; desc.textContent = post.Description || post.Texte || '';

        const thumbCon = document.createElement('div'); thumbCon.className = 'post-thumb-container';
        const img = document.createElement('img'); img.className = 'post-thumb'; img.alt = post.Name || '';
        img.loading = 'lazy';
        img.src = post['Url Thumb'] || post.Previously || post.image || 'https://via.placeholder.com/800x450?text=Preview';
        thumbCon.appendChild(img);

        thumbCon.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const src = post.Previously || post.video || post['Url Video'] || post['Url'] || post.image || post.media || '';
          if (!src) return;
          if (isPdf(src)) {
            // show ad first if desired, otherwise directly open
            // Here we directly open viewer (remove ad logic or keep as needed)
            openPdfViewer(src);
          } else {
            // simple inline play for images/videos
            playMediaInline(src, thumbCon);
          }
        });

        card.appendChild(title);
        card.appendChild(thumbCon);
        card.appendChild(desc);
        explorer.appendChild(card);
      });
    }

    function isPdf(src){
      if (!src) return false;
      try { return src.split('?')[0].toLowerCase().endsWith('.pdf'); } catch(e){ return false; }
    }

    function playMediaInline(src, container){
      container.innerHTML = '';
      if (looksLikeVideo(src)){
        const video = document.createElement('video');
        video.src = src;
        video.controls = true;
        video.autoplay = true;
        video.playsInline = true;
        video.style.maxWidth = '100%';
        video.style.height = 'auto';
        video.setAttribute('controlsList', 'nodownload');
        container.appendChild(video);
        video.addEventListener('error', ()=> container.innerHTML = '<div style="color:#999;padding:12px;text-align:center">M pa ka chaje videyo a</div>');
      } else {
        const img = document.createElement('img');
        img.src = src;
        img.loading = 'lazy';
        img.style.maxWidth = '100%';
        container.appendChild(img);
        img.addEventListener('error', ()=> container.innerHTML = '<div style="color:#999;padding:12px;text-align:center">Imaj pa disponib</div>');
      }
    }

    function looksLikeVideo(src){
      if (!src) return false;
      const s = src.split('?')[0].toLowerCase();
      return /\.(mp4|webm|ogg|mov|mkv)$/.test(s) || s.includes('youtube.com') || s.includes('youtu.be') || s.includes('vimeo.com');
    }

    function normalizeYouTubeEmbed(src){
      try {
        if (src.includes('youtu.be/')) {
          const id = src.split('youtu.be/')[1].split(/[?&]/)[0];
          return 'https://www.youtube.com/embed/' + id + '?autoplay=1&rel=0';
        }
        const u = new URL(src);
        const v = u.searchParams.get('v');
        if (v) return 'https://www.youtube.com/embed/' + v + '?autoplay=1&rel=0';
      } catch(e){}
      return src;
    }

    function normalizeVimeoEmbed(src){
      try {
        const parts = src.split('/');
        const id = parts.pop() || parts.pop();
        return 'https://player.vimeo.com/video/' + id + '?autoplay=1';
      } catch(e){}
      return src;
    }

    /* ========== PDF rendering: render ALL pages (scrollable) ========== */
    let currentPdf = null;
    let currentPdfUrl = null;

    async function openPdfViewer(url){
      if (!url) return;
      // show overlay fullscreen
      pdfOverlay.style.display = 'flex';
      pdfOverlay.setAttribute('aria-hidden', 'false');
      // lock scroll
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      pdfCanvasWrap.innerHTML = '';

      currentPdfUrl = url;

      if (pdfjsLib && pdfjsLib.getDocument) {
        try {
          const loadingTask = pdfjsLib.getDocument(url);
          currentPdf = await loadingTask.promise;
          const total = currentPdf.numPages;

          // render all pages sequentially
          for (let p = 1; p <= total; p++) {
            await renderPdfPageToCanvas(currentPdf, p);
          }
        } catch (e) {
          console.error('PDF.js load error', e);
          // fallback iframe if pdf.js can't render
          pdfCanvasWrap.innerHTML = '';
          const iframe = document.createElement('iframe');
          iframe.className = 'pdf-fallback-iframe';
          iframe.src = url;
          pdfCanvasWrap.appendChild(iframe);
        }
      } else {
        // no pdfjs -> iframe fallback
        pdfCanvasWrap.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.className = 'pdf-fallback-iframe';
        iframe.src = url;
        pdfCanvasWrap.appendChild(iframe);
      }
    }

    async function renderPdfPageToCanvas(pdfDoc, pageNumber) {
      try {
        const page = await pdfDoc.getPage(pageNumber);
        // start with a viewport at scale=1 to get original width
        const initialViewport = page.getViewport({ scale: 1 });
        // calculate scale to fit available width (95% of container width)
        const containerWidth = Math.max(320, Math.min(window.innerWidth, pdfCanvasWrap.clientWidth || window.innerWidth));
        const targetWidth = containerWidth * 0.95; // small margin
        const scale = (targetWidth / initialViewport.width) || 1;
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page';
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);

        const ctx = canvas.getContext('2d');
        const renderContext = { canvasContext: ctx, viewport };

        pdfCanvasWrap.appendChild(canvas);
        await page.render(renderContext).promise;
      } catch (err) {
        console.error('renderPdfPageToCanvas error', err);
      }
    }

    function closePdfViewer(){
      pdfOverlay.style.display = 'none';
      pdfOverlay.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      // destroy pdf if available
      try { if (currentPdf) currentPdf.destroy(); } catch(e){}
      currentPdf = null;
      currentPdfUrl = null;
      pdfCanvasWrap.innerHTML = '';
    }

    pdfCloseBtn.addEventListener('click', closePdfViewer);

    // close when tapping background
    pdfOverlay.addEventListener('click', (e) => {
      if (e.target === pdfOverlay) closePdfViewer();
    });

    // close on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (pdfOverlay.style.display === 'flex') closePdfViewer();
      }
    });

    // responsive: if window resizes while overlay open, re-render pages to fit new width
    let resizeTimeout = null;
    window.addEventListener('resize', () => {
      if (pdfOverlay.style.display !== 'flex') return;
      clearTimeout(resizeTimeout);
      // re-render small delay
      resizeTimeout = setTimeout(async () => {
        if (!currentPdfUrl) return;
        // re-open to re-render pages (destroy and render again)
        try {
          if (currentPdf) { try { currentPdf.destroy(); } catch(e){} }
        } catch(e){}
        // re-render
        openPdfViewer(currentPdfUrl);
      }, 350);
    });
  </script>
</body>
  </html>
